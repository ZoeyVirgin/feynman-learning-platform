import { createContext, useState, useContext, useEffect, useCallback } from 'react';
import apiClient from '../api/axios';

const AuthContext = createContext(null);

export function AuthProvider({ children }) {
    const [token, setToken] = useState(localStorage.getItem('token'));  // 保存token
    const [user, setUser] = useState(() => {
        try {
            const userData = localStorage.getItem('user');
            return userData ? JSON.parse(userData) : null; // 保存用户信息
        } catch (error) {
            console.error('Error parsing user data from localStorage:', error);
            localStorage.removeItem('user'); // 清除损坏的数据
            return null;
        }
    });
    const [initializing, setInitializing] = useState(true);

    const login = useCallback((newToken, userData) => {
        if (newToken) {
            setToken(newToken);
            localStorage.setItem('token', newToken);
        }
        if (userData) {
            setUser(userData);
            localStorage.setItem('user', JSON.stringify(userData));
        }
    }, []);

    const logout = useCallback(() => {
        setToken(null);
        setUser(null);
        localStorage.removeItem('token');
        localStorage.removeItem('user');
    }, []);

    // 静默刷新：尝试用 httpOnly 刷新令牌换新 access token
    const silentRefresh = useCallback(async () => {
        try {
            const res = await apiClient.post('/users/refresh', {});
            const newToken = res?.data?.token;
            const newUser = res?.data?.user;
            if (newToken) {
                login(newToken, newUser);
                return true;
            }
            return false;
        } catch {
            return false;
        }
    }, [login]);

    // 验证当前 token
    const verifyToken = useCallback(async () => {
        try {
            const response = await apiClient.get('/users/verify');
            setUser(response.data.user);
            return true;
        } catch (error) {
            // token无效：先尝试静默刷新
            const refreshed = await silentRefresh();
            if (refreshed) return true;
            logout();
            return false;
        }
    }, [logout, silentRefresh]);

    // 初始化：如果有 token 走校验；如果没有，也尝试刷新（因为 cookie 里可能还在）
    useEffect(() => {
        (async () => {
            if (token) await verifyToken();
            else await silentRefresh();
            setInitializing(false);
        })();
        // 监听全局刷新事件（来自 axios 响应拦截器）
        const onToken = (e) => login(e.detail?.token, e.detail?.user);
        const onLogout = () => logout();
        window.addEventListener('auth:token', onToken);
        window.addEventListener('auth:logout', onLogout);
        return () => {
            window.removeEventListener('auth:token', onToken);
            window.removeEventListener('auth:logout', onLogout);
        };
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    const value = { token, user, login, logout, verifyToken, silentRefresh, initializing };

    return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
}

// 自定义 Hook，方便使用
export function useAuth() {
    return useContext(AuthContext);
}
